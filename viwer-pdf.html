<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Feedback Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#fff;--fg:#0f172a;--muted:#64748b;--line:#e5e7eb;--shadow:0 10px 25px rgba(2,6,23,.06)}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .card{border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;background:#fff}
    .hd{padding:16px 20px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#f8fafc 0%,#ffffff 100%)}
    .bd{padding:16px 20px}
    .muted{color:var(--muted)}
    .btn{display:inline-block;background:#111827;color:#fff;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:600}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    iframe{width:100%;height:78vh;border:0}
    code{background:#f1f5f9;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd"><strong>Feedback</strong></div>
      <div class="bd" id="box">
        <p class="muted" id="msg">Cargando…</p>
      </div>
    </div>
    <p id="dbg" class="muted" style="font-size:12px;margin:8px 4px 0"></p>
  </div>

  <script>
    // Helpers
    const qs = new URLSearchParams(location.search);
    const SID = qs.get('sid') || '';     // studentId
    const CID = qs.get('cid') || '';     // courseId
    const TID = qs.get('tid') || '';     // stageId (unitId)
    const GAS = qs.get('gas') || '';     // GAS deployId
    const PDF = qs.get('pdf') || '';     // modo directo

    const box = document.getElementById('box');
    const msg = document.getElementById('msg');
    const dbg = document.getElementById('dbg');

    function renderReady(url){
      box.innerHTML =
        `<div class="row" style="margin-bottom:12px">
           <a class="btn" href="${url}" target="_blank" rel="noopener">Abrir PDF en nueva pestaña</a>
           <button id="refreshBtn" class="btn" style="background:#334155" onclick="location.reload()">Recargar</button>
         </div>
         <iframe src="${url}" allow="fullscreen"></iframe>`;
    }
    function renderPending(text){
      msg.textContent = text || 'Aún estamos generando tu informe. Vuelve más tarde o recarga.';
    }
    function renderError(text){
      box.innerHTML = `<p style="color:#b91c1c">${text}</p>
                       <p><button class="btn" style="background:#b91c1c" onclick="location.reload()">Reintentar</button></p>`;
    }

    // Modo A: PDF directo (demo express)
    if (PDF) {
      dbg.textContent = 'modo: pdf directo';
      renderReady(PDF);
    }
    // Modo B: JSONP contra tu Apps Script
    else {
      if (!SID || !CID || !TID || !GAS) {
        renderError('Faltan parámetros. Usa ?pdf=... (demo rápida) o ?sid=&cid=&tid=&gas=');
      } else {
        const jsonpUrl =
          'https://script.google.com/macros/s/' + encodeURIComponent(GAS) + '/exec'
          + '?path=feedback-jsonp'
          + '&callback=__faInit'
          + '&studentId=' + encodeURIComponent(SID)
          + '&courseId='  + encodeURIComponent(CID)
          + '&stageId='   + encodeURIComponent(TID);

        dbg.textContent = 'modo: jsonp — ' + jsonpUrl;

        // timeout por si el script no carga (CSP/ID inválido)
        const t = setTimeout(()=>renderError('No se pudo cargar el estado (JSONP). Revisa el ID de deploy/URL.'), 8000);

        // callback que invoca tu GAS
        window.__faInit = function(resp){
          clearTimeout(t);
          if (resp && resp.status === 'READY' && resp.urlPdf) {
            renderReady(resp.urlPdf);
          } else if (resp && resp.status === 'PENDING') {
            renderPending('Aún estamos generando tu informe. Esta página no se actualizará sola.');
          } else {
            renderError('Respuesta inválida o error en servidor.');
          }
        };

        // inyecta el <script> JSONP
        const s = document.createElement('script');
        s.src = jsonpUrl;
        s.async = true;
        s.onerror = () => { clearTimeout(t); renderError('No se pudo cargar el estado (JSONP).'); };
        document.body.appendChild(s);
      }
    }
  </script>
</body>
</html>
